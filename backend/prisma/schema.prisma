// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleType {
  ADMIN
  STAFF
}

enum ContactType {
  CUSTOMER
  VENDOR
}

enum CustomerType {
  BUSINESS
  INDIVIDUAL
}

enum PortalStatus {
  ENABLED
  DISABLED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  INVOICED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ItemType {
  SALES
  PURCHASE
  SERVICE
}

enum InvoiceItemType {
  ITEM
  HEADER
  TIMESHEET
}

enum PaymentStatus {
  DRAFT
  PAID
}

enum QuoteItemType {
  ITEM
  HEADER
  TIMESHEET
}

model Role {
  id        String   @id @default(uuid())
  name      RoleType @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

model User {
  id               String            @id @default(uuid())
  name             String
  firstName        String?
  lastName         String?
  email            String            @unique
  password         String
  phone            String?
  country          String?
  zipCode          String?
  roleId           String
  role             Role              @relation(fields: [roleId], references: [id])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  activityLogs     ActivityLog[]
  timesheets       Timesheet[]
  itemActivityLogs ItemActivityLog[]
}

model Contact {
  id               String                   @id @default(uuid())
  name             String
  email            String?
  phone            String?
  mobile           String?
  company          String?
  // Legacy address fields (keep for backward compatibility)
  address          String?
  city             String?
  state            String?
  zipCode          String?
  country          String?
  // Billing address
  billingAddress   String?
  billingCity      String?
  billingState     String?
  billingZipCode   String?
  billingCountry   String?
  // Shipping address
  shippingAddress  String?
  shippingCity     String?
  shippingState    String?
  shippingZipCode  String?
  shippingCountry  String?
  // Additional fields
  type             ContactType
  customerType     CustomerType?            @default(BUSINESS)
  defaultCurrency  String                   @default("INR")
  portalStatus     PortalStatus             @default(DISABLED)
  customerLanguage String                   @default("en")
  paymentTerms     String?
  isActive         Boolean                  @default(true)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  quotes           Quote[]
  invoices         Invoice[]
  projects         Project[]
  contactPersons   ContactPerson[]
  activityLogs     ActivityLog[]
  financialSummary ContactFinancialSummary?
}

model Item {
  id               String            @id @default(uuid())
  name             String
  description      String?
  rate             Decimal           @db.Decimal(10, 2)
  unit             String            @default("unit")
  taxRate          Decimal           @default(0) @db.Decimal(5, 2)
  itemType         ItemType          @default(SALES)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  quoteItems       QuoteItem[]
  invoiceItems     InvoiceItem[]
  itemActivityLogs ItemActivityLog[]
}

model Quote {
  id                 String      @id @default(uuid())
  quoteNumber        String      @unique
  contactId          String
  contact            Contact     @relation(fields: [contactId], references: [id])
  templateId         String?
  template           Template?   @relation(fields: [templateId], references: [id])
  projectId          String?
  project            Project?    @relation(fields: [projectId], references: [id])
  status             QuoteStatus @default(DRAFT)
  issueDate          DateTime    @default(now())
  expiryDate         DateTime?
  paymentTerms     String?
  subtotal           Decimal     @default(0) @db.Decimal(10, 2)
  taxAmount          Decimal     @default(0) @db.Decimal(10, 2)
  total              Decimal     @default(0) @db.Decimal(10, 2)
  notes              String?
  convertedToInvoice Boolean     @default(false)
  invoiceId          String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  items              QuoteItem[]
  invoices           Invoice[]   @relation("QuoteToInvoice")
}

model QuoteItem {
  id          String        @id @default(uuid())
  quoteId     String
  quote       Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  itemId      String?
  item        Item?         @relation(fields: [itemId], references: [id])
  type        QuoteItemType @default(ITEM)
  name        String
  description String?
  quantity    Decimal       @db.Decimal(10, 2)
  rate        Decimal       @db.Decimal(10, 2)
  taxRate     Decimal       @default(0) @db.Decimal(5, 2)
  amount      Decimal       @db.Decimal(10, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  contactId     String
  contact       Contact       @relation(fields: [contactId], references: [id])
  templateId    String?
  template      Template?     @relation(fields: [templateId], references: [id])
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id])
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  paymentTerms  String?
  subtotal      Decimal       @default(0) @db.Decimal(10, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @default(0) @db.Decimal(10, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(10, 2)
  notes         String?
  quoteId       String?
  quote         Quote?        @relation("QuoteToInvoice", fields: [quoteId], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         InvoiceItem[]
  payments      Payment[]
}

model InvoiceItem {
  id          String          @id @default(uuid())
  invoiceId   String
  invoice     Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  itemId      String?
  item        Item?           @relation(fields: [itemId], references: [id])
  type        InvoiceItemType @default(ITEM)
  name        String
  description String?
  quantity    Decimal         @db.Decimal(10, 2)
  rate        Decimal         @db.Decimal(10, 2)
  taxRate     Decimal         @default(0) @db.Decimal(5, 2)
  amount      Decimal         @db.Decimal(10, 2)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Project {
  id              String        @id @default(uuid())
  name            String
  description     String?
  contactId       String
  contact         Contact       @relation(fields: [contactId], references: [id])
  hourlyRate      Decimal       @db.Decimal(10, 2)
  status          ProjectStatus @default(ACTIVE)
  startDate       DateTime?
  endDate         DateTime?
  addToDashboard  Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  timesheets      Timesheet[]
  quotes          Quote[]
  invoices        Invoice[]
}

model Timesheet {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  customUserName String?
  date          DateTime
  hours         Decimal  @db.Decimal(5, 2)
  description   String?
  billable      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Template {
  id          String    @id @default(uuid())
  name        String
  description String?
  content     String    @db.Text
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  invoices    Invoice[]
  quotes      Quote[]
}

model ContactPerson {
  id          String   @id @default(uuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  phone       String?
  mobile      String?
  designation String?
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ActivityLog {
  id          String   @id @default(uuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
}

model ContactFinancialSummary {
  id                     String   @id @default(uuid())
  contactId              String   @unique
  contact                Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  outstandingReceivables Decimal  @default(0) @db.Decimal(10, 2)
  unusedCredits          Decimal  @default(0) @db.Decimal(10, 2)
  totalIncome            Decimal  @default(0) @db.Decimal(10, 2)
  lastUpdated            DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model ItemActivityLog {
  id          String   @id @default(uuid())
  itemId      String
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
}

model Payment {
  id              String        @id @default(uuid())
  invoiceId       String
  invoice         Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentNumber   String        @unique
  amountReceived  Decimal        @db.Decimal(10, 2)
  bankCharges     Decimal?      @db.Decimal(10, 2)
  pan             String?
  taxDeducted     Boolean       @default(false)
  tdsAmount       Decimal?      @db.Decimal(10, 2)
  paymentDate     DateTime      @default(now())
  paymentMode     String
  paymentReceivedOn DateTime?
  referenceNumber String?
  notes           String?
  status          PaymentStatus @default(DRAFT)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}
